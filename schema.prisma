// Prisma Schema per Progetto Reti 2
// Generated from Java JPA Entities

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// Utente - Gestione utenti amministrativi
model Utente {
  username String  @id @db.VarChar(255)
  password String  @db.VarChar(255)
  isAdmin  Boolean

  @@map("utenti")
}

// Veicolo - Anagrafica veicoli
model Veicolo {
  targa         String  @id @db.VarChar(255)
  tipoVeicolo   String  @db.VarChar(1) // A, B, C, D, E
  
  // Relazioni
  biglietti     Biglietto[]
  multe         Multa[]

  @@map("veicolo")
}

// Regione - Divisioni geografiche
model Regione {
  id        Int       @id @default(autoincrement()) @map("ID_REGIONE")
  nome      String    @db.VarChar(100)
  
  // Relazioni
  autostrade Autostrada[]

  @@map("REGIONE")
}

// Autostrada - Autostrade per regione
model Autostrada {
  id          Int       @id @default(autoincrement()) @map("id_autostrada")
  sigla       String    @db.VarChar(255)
  idRegione   Int       @map("id_regione")
  
  // Relazioni
  regione     Regione   @relation(fields: [idRegione], references: [id])
  caselli     Casello[]

  @@index([idRegione])
  @@map("autostrada")
}

// Casello - Caselli autostradali
model Casello {
  idCasello   Int       @id @default(autoincrement()) @map("id_casello")
  sigla       String    @db.VarChar(255)
  idAutostrada Int      @map("id_autostrada")
  isClosed    Boolean   @map("is_closed")
  limite      Int
  
  // Relazioni
  autostrada  Autostrada @relation(fields: [idAutostrada], references: [id])
  corsie      Corsia[]
  dispositivi Dispositivo[]
  biglietti   Biglietto[]
  pagamenti   Pagamento[]

  @@index([idAutostrada])
  @@map("casello")
}

// Corsia - Corsie all'interno dei caselli
model Corsia {
  numCorsia   Int       @map("num_corsia")
  idCasello   Int       @map("id_casello")
  verso       String    @db.VarChar(20) // ENTRATA, USCITA
  tipo        String    @db.VarChar(20) // MANUALE, TELEPASS, EMERGENZA
  isClosed    Boolean   @map("is_closed")
  
  // Relazioni
  casello     Casello   @relation(fields: [idCasello], references: [idCasello])
  dispositivi Dispositivo[]

  @@id([numCorsia, idCasello])
  @@index([idCasello])
  @@map("corsia")
}

// Dispositivo - Classe astratta per dispositivi (SINGLE_TABLE inheritance)
model Dispositivo {
  id              Int       @id @default(autoincrement()) @map("id_dispositivo")
  numCorsia       Int       @map("num_corsia")
  idCasello       Int       @map("id_casello")
  status          Boolean   @map("stato")
  tipoDispositivo String    @map("tipo_dispositivo") @db.VarChar(255)
  
  // Relazioni
  corsia          Corsia?   @relation(fields: [numCorsia, idCasello], references: [numCorsia, idCasello])
  
  // Relazioni per i sottotipi (se implementati come separate)
  totem           Totem?
  telecamera      Telecamera?
  sbarra          Sbarra?

  @@index([numCorsia, idCasello])
  @@map("dispositivo")
}

// Totem - Dispositivo per emissione biglietti
model Totem {
  id        Int       @id
  dispositivo Dispositivo @relation(fields: [id], references: [id])
  
  // Relazioni
  biglietti Biglietto[]

  @@map("totem")
}

// Telecamera - Dispositivo di videosorveglianza
model Telecamera {
  id        Int       @id
  dispositivo Dispositivo @relation(fields: [id], references: [id])

  @@map("telecamera")
}

// Sbarra - Dispositivo di controllo accesso
model Sbarra {
  id        Int       @id
  dispositivo Dispositivo @relation(fields: [id], references: [id])

  @@map("sbarra")
}

// Biglietto - Biglietti di viaggio
model Biglietto {
  idBiglietto Int       @id @default(autoincrement()) @map("id_biglietto")
  idTotem     Int?      @map("id_totem")
  targa       String    @db.VarChar(255)
  timestampIn DateTime  @map("timestamp_in") @db.Timestamp()
  caselloIn   Int       @map("casello_in")
  
  // Relazioni
  totem       Totem?    @relation(fields: [idTotem], references: [id])
  veicolo     Veicolo   @relation(fields: [targa], references: [targa])
  casello     Casello   @relation(fields: [caselloIn], references: [idCasello])
  pagamenti   Pagamento[]
  multe       Multa[]

  @@index([idTotem])
  @@index([targa])
  @@index([caselloIn])
  @@map("biglietto")
}

// Pagamento - Storico pagamenti
model Pagamento {
  idPagamento Int       @id @default(autoincrement()) @map("id_pagamento")
  idBiglietto Int       @map("id_biglietto")
  importo     Float
  stato       String    @db.VarChar(50) // PAGATO, NON_PAGATO
  timestampOut DateTime @map("timestamp_out") @db.Timestamp()
  caselloOut  Int       @map("casello_out")
  
  // Relazioni
  biglietto   Biglietto @relation(fields: [idBiglietto], references: [idBiglietto])
  casello     Casello   @relation(fields: [caselloOut], references: [idCasello])

  @@index([idBiglietto])
  @@index([caselloOut])
  @@map("pagamento")
}

// Multa - Sanzioni amministrative
model Multa {
  id        Int       @id @default(autoincrement()) @map("id_multa")
  targa     String    @db.VarChar(255)
  importo   Float
  pagato    Boolean
  idBiglietto Int?    @map("id_biglietto")
  
  // Relazioni
  veicolo   Veicolo   @relation(fields: [targa], references: [targa])
  biglietto Biglietto? @relation(fields: [idBiglietto], references: [idBiglietto])

  @@index([targa])
  @@index([idBiglietto])
  @@map("multa")
}
