import ujsonimport timeclass GestoreBroker:    def __init__(self, broker):        self.broker = broker        self.risposte = {}  # Dizionario per memorizzare le risposte per topic        self.topic_corrente = None        self.broker.set_callback(self.callback_globale)    def callback_globale(self, topic, msg):        t = topic.decode()        try:            payload = msg.decode() if isinstance(msg, bytes) else msg            self.risposte[t] = ujson.loads(payload)            print(f"üì© Messaggio ricevuto su {t}")        except Exception as e:            print(f"‚ùå Errore decodifica JSON su {t}:", e)    def richiedi(self, topic_invio, payload, topic_risposta, timeout=3):        # 1. Mi iscrivo al topic dove il server risponder√†        print(f"üì• Iscrizione a {topic_risposta}...")        self.broker.subscribe(topic_risposta)        # 2. Pulisco vecchia cache per questo topic specifico        self.risposte[topic_risposta] = None        # 3. Invio la richiesta        print(f"üì§ Pubblicazione su {topic_invio}...")        self.broker.publish(topic_invio, ujson.dumps(payload))        # 4. Loop di attesa        start = time.time()        while (time.time() - start) < timeout:            self.broker.check_msg()            if self.risposte.get(topic_risposta) is not None:                return self.risposte[topic_risposta]            time.sleep(0.1)        print(f"‚ö†Ô∏è Timeout: nessuna risposta da {topic_risposta} dopo {timeout}s")        return None