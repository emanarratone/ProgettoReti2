<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Explorer rete - Autostrada</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .breadcrumb-custom {
      font-size: 0.9rem;
    }
    .breadcrumb-custom span {
      color: var(--muted);
    }
    .breadcrumb-custom a {
      text-decoration: none;
      color: var(--accent);
      cursor: pointer;
    }
    .breadcrumb-custom a:hover {
      text-decoration: underline;
    }
    .level-title {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--muted);
    }
    .list-group-item {
      cursor: pointer;
    }
    .list-group-item.active-level {
      background-color: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
  </style>
</head>
<body>
<header class="topbar py-2 mb-3">
  <div class="container-fluid">
    <div class="d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-3">
        <h4 class="mb-0">Gestionale Autostradale</h4>
        <span id="roleBadge" class="role-badge" style="display:none;">Amministratore</span>
      </div>
      <div class="d-flex align-items-center gap-3">
        <button id="logoutBtn" class="btn btn-outline-danger btn-sm">Logout</button>
      </div>
    </div>
  </div>
</header>

<main class="container-fluid py-2">
  <!-- Barra orizzontale dei livelli -->
  <div class="card bg-white p-3 mb-3">
    <ul class="list-group list-group-horizontal list-group-flush w-100" id="levelList">
      <li class="list-group-item flex-fill text-center active-level" data-level="highways">
        <strong>Autostrada</strong>
      </li>
      <li class="list-group-item flex-fill text-center" data-level="tolls">
        <span class="text-muted">&gt;</span> Casello
      </li>
      <li class="list-group-item flex-fill text-center" data-level="lanes">
        <span class="text-muted">&gt;</span> Corsia
      </li>
      <li class="list-group-item flex-fill text-center" data-level="devices">
        <span class="text-muted">&gt;</span> Dispositivi
      </li>
    </ul>
    <div class="small-muted mt-2" id="pathSummary">
      Seleziona un'autostrada per iniziare.
    </div>
  </div>

  <!-- Lista corrente -->
  <div class="card bg-white p-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div>
        <div class="level-title" id="levelTitle">AUTOSTRADE</div>
      </div>
      <div id="status" class="small-muted"></div>
    </div>
    <ul class="list-group" id="itemsList"></ul>
  </div>
</main>

<footer class="text-center py-3 small text-muted">
  © Gestionale Autostradale — <span id="buildInfo">v1.0</span>
</footer>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // Logout coerente con dashboard
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', function () {
      fetch('/api/logout', {
        method: 'POST',
        credentials: 'same-origin'
      })
        .then(res => {
          if (!res.ok) {
            throw new Error('HTTP ' + res.status);
          }
          return res.json().catch(() => ({}));
        })
        .then(() => {
          window.location.href = '/index.html';
        })
        .catch(err => {
          console.error('Errore nel logout:', err);
          window.location.href = '/index.html';
        });
    });
  }

  // Stato corrente
  const state = {
    highway: null,
    toll: null,
    lane: null
  };

  const itemsList   = document.getElementById('itemsList');
  const statusEl    = document.getElementById('status');
  const levelTitle  = document.getElementById('levelTitle');
  const pathSummary = document.getElementById('pathSummary');

  function setStatus(msg) {
    statusEl.textContent = msg || '';
  }

  function updatePathSummary() {
    const parts = [];
    if (state.highway) parts.push(state.highway.name);
    if (state.toll)    parts.push(state.toll.name);
    if (state.lane)    parts.push(state.lane.name);
    pathSummary.textContent = parts.length
      ? parts.join(' > ')
      : "Seleziona un'autostrada per iniziare.";
  }

  function setActiveLevel(level) {
    document.querySelectorAll('#levelList .list-group-item').forEach(li => {
      li.classList.toggle('active-level', li.dataset.level === level);
    });
  }

  function resetBelow(level) {
    if (level === 'highway') {
      state.toll = null;
      state.lane = null;
    } else if (level === 'toll') {
      state.lane = null;
    }
  }

  // --- Caricamenti ---

  // Autostrade
  function loadHighways() {
    setActiveLevel('highways');
    levelTitle.textContent = 'AUTOSTRADE';
    setStatus('Caricamento autostrade...');
    itemsList.innerHTML = '';

    fetch('/api/highways')
      .then(res => {
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return res.json();
      })
      .then(data => {
        if (!Array.isArray(data) || data.length === 0) {
          setStatus('Nessuna autostrada trovata.');
          return;
        }
        setStatus('Seleziona un\'autostrada per vedere i caselli.');
        data.forEach(h => {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          const name = h.nome_autostrada || h.name || ('Autostrada ' + h.id);
          li.innerHTML = `
            <div>
              <strong>${name}</strong>
              <div class="small-muted">${h.nome_regione || h.regione || ''}</div>
            </div>
          `;
          li.addEventListener('click', () => {
            state.highway = { id: h.id_autostrada || h.id, name };
            resetBelow('highway');
            updatePathSummary();
            loadTollsForHighway(state.highway.id);
          });
          itemsList.appendChild(li);
        });
      })
      .catch(err => {
        console.error('Errore caricamento autostrade:', err);
        setStatus('Errore nel caricamento delle autostrade.');
      });
  }

  // Caselli per autostrada
  function loadTollsForHighway(highwayId) {
    if (!highwayId) return;
    setActiveLevel('tolls');
    levelTitle.textContent = 'CASELLI DI ' + state.highway.name;
    setStatus('Caricamento caselli...');
    itemsList.innerHTML = '';

    fetch('/api/highways/' + encodeURIComponent(highwayId) + '/tolls')
      .then(res => {
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return res.json();
      })
      .then(data => {
        if (!Array.isArray(data) || data.length === 0) {
          setStatus('Nessun casello trovato per questa autostrada.');
          return;
        }
        setStatus('Seleziona un casello per vedere le corsie.');
        data.forEach(t => {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          const name = t.nome_casello || t.name || ('Casello ' + t.id);
          li.innerHTML = `
            <div>
              <strong>${name}</strong>
              <div class="small-muted">${t.km ? ('Km ' + t.km) : ''}</div>
            </div>
          `;
          li.addEventListener('click', () => {
            state.toll = { id: t.id_casello || t.id, name };
            resetBelow('toll');
            updatePathSummary();
            loadLanesForToll(state.toll.id);
          });
          itemsList.appendChild(li);
        });
      })
      .catch(err => {
        console.error('Errore caricamento caselli:', err);
        setStatus('Errore nel caricamento dei caselli.');
      });
  }

  // Corsie per casello
  function loadLanesForToll(tollId) {
    if (!tollId) return;
    setActiveLevel('lanes');
    levelTitle.textContent = 'CORSIE DI ' + state.toll.name;
    setStatus('Caricamento corsie...');
    itemsList.innerHTML = '';

    fetch('/api/tolls/' + encodeURIComponent(tollId) + '/lanes')
      .then(res => {
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return res.json();
      })
      .then(data => {
        if (!Array.isArray(data) || data.length === 0) {
          setStatus('Nessuna corsia trovata per questo casello.');
          return;
        }
        setStatus('Seleziona una corsia per vedere i dispositivi.');
        data.forEach(l => {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          const name = l.nome_corsia || l.name || ('Corsia ' + l.id);
          li.innerHTML = `
            <div>
              <strong>${name}</strong>
              <div class="small-muted">${l.direzione || ''}</div>
            </div>
          `;
          li.addEventListener('click', () => {
            state.lane = { id: l.id_corsia || l.id, name };
            updatePathSummary();
            loadDevicesForLane(state.lane.id);
          });
          itemsList.appendChild(li);
        });
      })
      .catch(err => {
        console.error('Errore caricamento corsie:', err);
        setStatus('Errore nel caricamento delle corsie.');
      });
  }

  // Dispositivi per corsia
  function loadDevicesForLane(laneId) {
    if (!laneId) return;
    setActiveLevel('devices');
    levelTitle.textContent = 'DISPOSITIVI DI ' + state.lane.name;
    setStatus('Caricamento dispositivi...');
    itemsList.innerHTML = '';

    fetch('/api/lanes/' + encodeURIComponent(laneId) + '/devices')
      .then(res => {
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return res.json();
      })
      .then(data => {
        if (!Array.isArray(data) || data.length === 0) {
          setStatus('Nessun dispositivo trovato per questa corsia.');
          return;
        }
        setStatus('Elenco dispositivi.');
        data.forEach(d => {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          const type = d.tipo || d.type || 'Dispositivo';
          const id   = d.id_dispositivo || d.id;
          const pos  = d.posizione || '';
          li.innerHTML = `
            <div>
              <strong>${type}</strong>
              <div class="small-muted">ID: ${id} ${pos ? '— ' + pos : ''}</div>
            </div>
          `;
          itemsList.appendChild(li);
        });
      })
      .catch(err => {
        console.error('Errore caricamento dispositivi:', err);
        setStatus('Errore nel caricamento dei dispositivi.');
      });
  }

  // Avvio
  loadHighways();
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
</body>
</html>
