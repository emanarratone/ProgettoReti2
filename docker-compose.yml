services:
  db:
    image: postgres:15
    environment:
      POSTGRES_DB: autostrada
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: admin
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d autostrada"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  autostrada-service:
    build: ./autostrada-service
    ports:
      - "8081:8081"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/autostrada
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=admin
    depends_on:
      - db
    restart: unless-stopped

  casello-service:
    build: ./casello-service
    ports:
      - "8082:8082"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/autostrada
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=admin
    depends_on:
      - db
    restart: unless-stopped

  corsia-service:
    build: ./corsia-service
    ports:
      - "8083:8083"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/autostrada
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=admin
    depends_on:
      - db
    restart: unless-stopped

  autostrada-service-dispositivi:
    build: ./dispositivi-service
    ports:
      - "8085:8085"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/autostrada
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=admin
    depends_on:
      - db
    restart: unless-stopped

  biglietto-service:
    build: ./biglietto-service
    ports:
      - "8086:8086"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/autostrada
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=admin
    depends_on:
      - db
    restart: unless-stopped

  pagamento-service:
    build: ./pagamento-service
    ports:
      - "8087:8087"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/autostrada
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=admin
    depends_on:
      - db
    restart: unless-stopped

  multa-service:
    build: ./multa-service
    ports:
      - "8088:8088"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/autostrada
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=admin
    depends_on:
      - db
    restart: unless-stopped

  veicolo-service:
    build: ./veicolo-service
    ports:
      - "8089:8089"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/autostrada
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=admin
    depends_on:
      - db
    restart: unless-stopped

  regione-service:
    build: ./regione-service
    ports:
      - "8084:8084"
    depends_on:
      - db
    restart: unless-stopped

  utente-service:
    build: ./utente-service
    ports:
      - "8090:8090"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/autostrada
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=admin
    depends_on:
      - db
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8090/users || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  legacy-service:
    build: .
    ports:
      - "3000:3000"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/autostrada
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=admin
    depends_on:
      - db
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/traffic || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  frontend-service:
    build: ./frontend-service
    ports:
      - "8080:8080"
    environment:
      - SERVER_SSL_ENABLED=false
      - BACKEND_AUTOSTRADA_URL=http://autostrada-service:8081
      - BACKEND_CASELLO_URL=http://casello-service:8082
      - BACKEND_CORSIA_URL=http://corsia-service:8083
      - BACKEND_REGIONE_URL=http://regione-service:8084
      - BACKEND_DISPOSITIVI_URL=http://autostrada-service-dispositivi:8085
      - BACKEND_BIGLIETTO_URL=http://biglietto-service:8086
      - BACKEND_PAGAMENTO_URL=http://pagamento-service:8087
      - BACKEND_MULTA_URL=http://multa-service:8088
      - BACKEND_VEICOLO_URL=http://veicolo-service:8089
      - BACKEND_UTENTE_URL=http://utente-service:8090
      - BACKEND_LEGACY_URL=http://legacy-service:3000
    depends_on:
      - autostrada-service
      - casello-service
      - corsia-service
      - regione-service
      - autostrada-service-dispositivi
      - biglietto-service
      - pagamento-service
      - multa-service
      - veicolo-service
      - utente-service
      - legacy-service
    restart: unless-stopped

volumes:
  pgdata: {}
